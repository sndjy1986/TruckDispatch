<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #004c99;
  }
  #map {
    width: 100%;
    height: 450px;
    margin-top: 10px;
    border-radius: 10px;
  }
  .dispatch-panel {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  select {
    padding: 8px;
    margin-left: 8px;
  }
</style>
</head>
<body>

<h1>Dispatch Map (Drive-Time Routing)</h1>
<div id="map"></div>

<div class="dispatch-panel">
  <h2>Closest Unit (By Road)</h2>
  <div id="closestTruck">Calculating...</div>
  <button id="dispatchBtn">Dispatch Closest Truck</button>

  <h3>Or Send Another Unit</h3>
  <select id="alternateSelect"></select>
  <button id="sendAlternateBtn">Dispatch Selected Unit</button>
</div>

<script>
  const SHEET_ID = "1bV1uBrj3hOv55qhoLAuXHGFUaP92_bYPA9HhypyTXs0";
  const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImRjYzYwMTAxMmQ3NzRmODNhMGIwYTE5NDgzY2Y5Yzc4IiwiaCI6Im11cm11cjY0In0=";  // ðŸ”‘ <-- Replace with your key

  const params = new URLSearchParams(window.location.search);
  const address = params.get("address");
  let map, callMarker, trucks = [], closest = null;

  // Initialize map
  map = L.map("map").setView([34.5212, -82.6484], 10);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  async function locateAddress() {
    try {
      const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ", SC")}`);
      const data = await resp.json();
      if (data.length === 0) {
        alert("Address not found on map.");
        return;
      }
      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      callMarker = L.marker([lat, lon]).addTo(map).bindPopup(`<b>Call Location</b><br>${address}`).openPopup();
      map.setView([lat, lon], 12);
      loadTrucks(lat, lon);
    } catch (err) {
      alert("Error locating address: " + err);
    }
  }

  async function loadTrucks(callLat, callLon) {
    try {
      const res = await fetch(API_URL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;

      trucks = rows.map(r => ({
        truck: r.c[0]?.v,
        status: r.c[1]?.v,
        lat: parseFloat((r.c[2]?.v || "").toString().replace(/[â€“â€”]/g, "-")),
        lon: parseFloat((r.c[3]?.v || "").toString().replace(/[â€“â€”]/g, "-")),
      })).filter(t => t.status === "Available" && !isNaN(t.lat) && !isNaN(t.lon));

      trucks.forEach(t => {
        L.marker([t.lat, t.lon], { title: t.truck })
          .addTo(map)
          .bindPopup(`<b>${t.truck}</b><br>Available`);
      });

      await findClosestTruck(callLat, callLon);
    } catch (err) {
      alert("Error loading truck data: " + err);
    }
  }

  async function findClosestTruck(callLat, callLon) {
    const results = [];
    for (const t of trucks) {
      const distance = await getDrivingDistance(t.lat, t.lon, callLat, callLon);
      if (distance !== null) {
        results.push({ ...t, distance });
      }
    }

    results.sort((a, b) => a.distance - b.distance);
    closest = results[0];

    const dropdown = document.getElementById("alternateSelect");
    dropdown.innerHTML = "";
    results.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.truck;
      opt.textContent = `${t.truck} - ${t.distance.toFixed(2)} mi`;
      dropdown.appendChild(opt);
    });

    document.getElementById("closestTruck").textContent =
      `${closest.truck} (${closest.distance.toFixed(2)} mi by road)`;
  }

  async function getDrivingDistance(lat1, lon1, lat2, lon2) {
    try {
      const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car", {
        method: "POST",
        headers: {
          "Authorization": ORS_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          coordinates: [
            [lon1, lat1],
            [lon2, lat2]
          ]
        })
      });

      const data = await res.json();
      const meters = data.features[0].properties.summary.distance;
      const miles = meters / 1609.34;
      return miles;
    } catch (err) {
      console.error("ORS routing error:", err);
      return null;
    }
  }

  function dispatchTruck(truckName) {
    let activeTrucks = JSON.parse(localStorage.getItem("activeTrucks") || "[]");
    const dispatched = {
      truck: truckName,
      address: address,
      status: "En Route",
      elapsed: 0,
      lastUpdate: Date.now()
    };
    activeTrucks.push(dispatched);
    localStorage.setItem("activeTrucks", JSON.stringify(activeTrucks));
    window.location.href = "index.html";
  }

  document.getElementById("dispatchBtn").addEventListener("click", () => {
    if (!closest) return alert("No truck data loaded yet.");
    dispatchTruck(closest.truck);
  });

  document.getElementById("sendAlternateBtn").addEventListener("click", () => {
    const alt = document.getElementById("alternateSelect").value;
    if (!alt) return alert("Select a unit first.");
    dispatchTruck(alt);
  });

  locateAddress();
</script>
</body>
</html>
