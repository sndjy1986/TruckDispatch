<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Map</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    margin: 0;
    padding: 20px;
  }
  h1 { text-align: center; color: #004c99; }
  #map {
    width: 100%;
    height: 400px;
    border-radius: 10px;
    margin-top: 10px;
  }
  .dispatch-panel {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-top: 20px;
  }
  .dispatch-panel h2, .dispatch-panel h3 { margin-top: 0; }
  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    margin-top: 5px;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  select {
    padding: 8px;
    margin-left: 10px;
  }
</style>
</head>
<body>

<h1>Dispatch Map</h1>
<div id="map"></div>

<div class="dispatch-panel">
  <h2>Closest Unit</h2>
  <div id="closestTruck">Loading...</div>
  <button id="dispatchBtn">Dispatch Closest Truck</button>

  <h3>Or Send Another Unit</h3>
  <select id="alternateSelect"></select>
  <button id="sendAlternateBtn">Dispatch Selected Unit</button>
</div>

<script>
  const SHEET_ID = "1bV1uBrj3hOv55qhoLAuXHGFUaP92_bYPA9HhypyTXs0";
  const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const params = new URLSearchParams(window.location.search);
  const address = params.get("address");

  let trucks = [];
  let closest = null;
  let map, callLoc;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 34.5212, lng: -82.6484 },
      zoom: 10
    });

    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: address + ", SC" }, (results, status) => {
      if (status === "OK") {
        callLoc = results[0].geometry.location;
        new google.maps.Marker({
          map,
          position: callLoc,
          label: "📍",
          title: address
        });
        map.setCenter(callLoc);
        loadTrucks();
      } else {
        alert("Could not find location: " + status);
      }
    });
  }

  async function loadTrucks() {
    try {
      const res = await fetch(API_URL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;

      trucks = rows.map(r => ({
        truck: r.c[0]?.v,
        status: r.c[1]?.v,
        lat: parseFloat((r.c[2]?.v || "").toString().replace(/[–—]/g, "-")),
        lon: parseFloat((r.c[3]?.v || "").toString().replace(/[–—]/g, "-")),
      })).filter(t => t.status === "Available" && !isNaN(t.lat) && !isNaN(t.lon));

      findClosestTruck();
    } catch (err) {
      alert("Error loading trucks: " + err);
    }
  }

  function findClosestTruck() {
    const distances = trucks.map(t => ({
      ...t,
      distance: haversine(callLoc.lat(), callLoc.lng(), t.lat, t.lon)
    }));
    distances.sort((a, b) => a.distance - b.distance);

    closest = distances[0];
    const dropdown = document.getElementById("alternateSelect");
    dropdown.innerHTML = "";

    distances.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.truck;
      opt.textContent = `${t.truck} - ${t.distance.toFixed(2)} mi`;
      dropdown.appendChild(opt);
    });

    document.getElementById("closestTruck").textContent =
      `${closest.truck} (${closest.distance.toFixed(2)} mi away)`;

    new google.maps.Marker({
      map,
      position: { lat: closest.lat, lng: closest.lon },
      label: closest.truck
    });
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 3958.8; // miles
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.asin(Math.sqrt(a));
  }

  function dispatchTruck(truckName) {
    let activeTrucks = JSON.parse(localStorage.getItem("activeTrucks") || "[]");
    const dispatched = {
      truck: truckName,
      address: address,
      status: "En Route",
      elapsed: 0,
      lastUpdate: Date.now()
    };
    activeTrucks.push(dispatched);
    localStorage.setItem("activeTrucks", JSON.stringify(activeTrucks));
    window.location.href = "index.html";
  }

  document.getElementById("dispatchBtn").addEventListener("click", () => {
    if (!closest) return alert("No truck data loaded yet.");
    dispatchTruck(closest.truck);
  });

  document.getElementById("sendAlternateBtn").addEventListener("click", () => {
    const alt = document.getElementById("alternateSelect").value;
    if (!alt) return alert("Select a unit first.");
    dispatchTruck(alt);
  });
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
</script>

</body>
</html>
